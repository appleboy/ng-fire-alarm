/*! angular-on-fire - v0.1.0 - 2013-09-28
* Copyright (c) 2013 []();
 Licensed  */
(function(){function a(a){function b(){}return b.prototype=a,new b}function b(a,b){function c(){}return c.prototype=(a.superclass=b).prototype,(a.prototype=new c).constructor=a,"function"==typeof b.extended&&b.extended(a),a}function c(a,b){var c={}.hasOwnProperty;for(var d in b)c.call(b,d)&&(a[d]=b[d]);return a}function d(a,b,c){return function(){return(c||a)[b].apply(a,arguments)}}(function(){var e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x;e=angular.isString,f=angular.isArray,g=angular.isFunction,h=angular.isObject,i=angular.isNumber,j=angular.noop,k=angular.forEach,l=angular.bind,m=angular.extend,n=angular.module,o=function(b,c){return b.$ref=c.ref(),b.$name=c.name(),b.$priority=c.getPriority(),a(b)},p=function(a,b){return b||(b=a.val()),m(o({},a),h(b)?b:{$value:b})},q=l(this,setTimeout),this.DataFlow=r=function(){function a(a){m(this,a)}a.displayName="DataFlow";var b=a.prototype;return a.immediate=function(){return a._immediate.apply(a,arguments)},a.interpolate=function(){return a._interpolate.apply(a,arguments)},a.parse=function(){return a._parse.apply(a,arguments)},a._snap2Value=function(a){var b,c,d,e,g;return b=a.val(),c=f(b)||this.toCollection?{proto:[],valFn:function(a){g.push(p(a))}}:{proto:{},valFn:function(a){g[a.name()]=a.val()}},d=c.proto,e=c.valFn,g=o(d,a),a.forEach(e),g},b._setSync=function(a){var b;this.sync=a,(b=this.next)&&b._setSync(a,this)},b.stop=function(){this.next&&this.next.stop()},a}(),s=function(a){function d(){d.superclass.apply(this,arguments)}var e=b((c(d,a).displayName="ToSyncFlow",d),a).prototype;return e.start=function(a){var b=this;this.constructor.immediate(function(){var c,d,e,f={}.hasOwnProperty;c=b.sync;for(d in c)f.call(c,d)&&delete c[d];k(a,function(a,b){return c[b]=a}),(e=parseInt(a.length))&&(c.length=e),c._set$(a)})},d}(r),this.FireSync=t=function(){function b(){this._set$=d(this,"_set$",c),this._head=this._tail=void 0}b.displayName="FireSync";var c=b.prototype;return c._set$=function(a){this.$ref=a.$ref,this.$name=a.$name,this.$priority=a.$priority},c._addFlow=function(a){var b;return this._head||(this._head=a),(b=this._tail)&&(b.next=a),this._tail=a,this},c._checkIsSynced=function(){var a;if((a=this._dataflows)[a.length-1]instanceof s)throw new Error("Already sync!")},c.get=function(a,b){var c;return this._addFlow(new v((c=b||{},c.queryStr=a,c)))},c.map=function(a){return this._addFlow(new w({queryString:a}))},c.flatten=function(){return this._addFlow(new x)},c.sync=function(){var b;return b=a(this._addFlow(new s)),b._head._setSync(b),b._head.start(),b},c.syncWithScope=function(a){var b=this;return this._scope=a,this._cleanupScope=function(){delete b._scope},this.sync()},c.destroy=function(){this._head.stop(),this._cleanupScope()},c._watch=function(){var a;return(a=this._scope).$watch.apply(a,arguments)},b}(),u=/\{\{\s*(\S*)\s*\}\}/g,v=function(a){function d(){d.superclass.apply(this,arguments)}var e=b((c(d,a).displayName="GetFlow",d),a).prototype;return e.start=function(){var a,b,c,d,e,f=this;a=this.constructor,b=a._snap2Value,c=a.interpolate,d=function(a){f.next.start(b.call(f,a))},e=function(a){f.query&&f.query.off("value"),f.query=new Firebase(a),f.query.on("value",d)},u.test(this.queryStr)?this.stopWatch=this.sync._watch(c(this.queryStr),e):e(this.queryStr)},e.stop=function(){var b;(b=this.stopWatch)&&b(),this.query.off("value"),a.prototype.stop.call(this)},d}(r),w=function(a){function d(){var a;d.superclass.apply(this,arguments),this.stopWatches=[],this.queries=[],this.mappedResult=[],this.queryFuncs=[],a=this.constructor.interpolate,k(this.queryString.split(u),function(b,c){this.queryFuncs.push(c%2?a("{{ "+b+" }}"):b)},this)}var e=b((c(d,a).displayName="MapFlow",d),a).prototype;return e._setSync=function(b,c){c.toCollection=!0,a.prototype._setSync.apply(this,arguments)},e.start=function(a){var b,c,d,e,f,g,h=this;this.stop(),b=this.constructor._snap2Value,c=this.sync,d=this.stopWatches,e=this.queries,f=this.mappedResult,g=this.queryFuncs,k(a,function(a,l){var m;if(!i(l))throw new TypeError("Map require result is array");m=function(b){var c;return c="",k(g,function(d,e){return c+=e%2?d(b)||d(a):d}),c},d.push(c._watch(m,function(a){var c,d;(c=e[l])&&c.off(),d=new Firebase(a),d.on("value",function(a){var c,d,e,g,h;for(console.log(this.toCollection,a.val()),f[l]=b.call(this,a),c=!0,d=0,g=(e=f).length;g>d;++d)h=e[d],h||(c=!1);c&&this.next.start(f)},j,h),e[l]=d}))})},e.stop=function(){for(var b;b=this.stopWatches.shift();)b();for(;b=this.queries.shift();)b.off();this.mappedResult=[],a.prototype.stop.call(this)},d}(r),x=function(a){function d(){d.superclass.apply(this,arguments)}var e=b((c(d,a).displayName="FlattenDataFlow",d),a).prototype;return e._setSync=function(b,c){c.toCollection=!0,a.prototype._setSync.apply(this,arguments)},e.start=function(a){var b;b=[],k(a,function(a,c){if(!i(c))throw new TypeError("Flatten require result["+c+"] is array");b.push.apply(b,a)}),this.next.start(b)},d}(r)}).call(this)}).call(this);