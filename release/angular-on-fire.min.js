/*! angular-on-fire - v0.1.0 - 2013-10-10
* Copyright (c) 2013 [tomchentw](https://github.com/tomchentw/);
 Licensed MIT */
(function(){function a(a,b){function c(){}return c.prototype=(a.superclass=b).prototype,(a.prototype=new c).constructor=a,"function"==typeof b.extended&&b.extended(a),a}function b(a,b){var c={}.hasOwnProperty;for(var d in b)c.call(b,d)&&(a[d]=b[d]);return a}function c(a){function b(){}return b.prototype=a,new b}var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F;d=angular.isString,e=angular.isArray,f=angular.isFunction,g=angular.isObject,h=angular.isNumber,i=angular.noop,j=angular.identity,k=angular.forEach,l=angular.bind,m=angular.copy,n=angular.extend,o=angular.module,p=["limit","startAt","endAt"],q=function(){function a(a){n(this,a),this.next=b}a.displayName="DataFlow";var b,c,d=a.prototype;d.cloneChained=function(){var a;return a=new this.constructor(this),a.next=this.next.cloneChained(),a},d.setSync=function(a){this.sync=a,this.next.setSync(a,this)},d.start=i,d.stop=function(){this.next.stop()},b={};for(c in a.prototype)b[c]=i;return a}(),r=function(c){function e(){var a,b,c,d,g,h,i;for(e.superclass.apply(this,arguments),a=q.interpolate,b=[],c=0,g=(d=this.queryString.split(f)).length;g>c;++c)h=c,i=d[c],h%2?b.push(a("{{ "+i+" }}")):b.push(i);this.queryFuncs=b}var f,g=a((b(e,c).displayName="InterpolateFlow",e),c).prototype;return e.createFirebase=function(a){var b;return a||(a=""),b="http"!==a.substr(0,4)?this.FirebaseUrl+a:a,new this.Firebase(b)},f=/\{\{\s*(\S*)\s*\}\}/g,g._buildWatchFn=function(a){var b;return b=this.queryFuncs,function(c){var e,f,g,h,i,j,k;for(f=[],g=0,i=(h=b).length;i>g;++g){if(j=g,k=h[g],j%2&&(k=k(c)||k(a),!d(k)||!k.length))return;f.push(k)}return e=f,e.join("")}},e}(q),s=function(c){function d(){d.superclass.apply(this,arguments),this.query=e,this.stopWatch=i}var e,f,g,h,j,k,l=a((b(d,c).displayName="GetFlow",d),c).prototype;for(e={on:i,off:i},f=function(){return e},g=0,j=(h=p).length;j>g;++g)k=h[g],e[k]=f;return l.start=function(){var a,b=this;a=function(a){a&&b._updateQuery(r.createFirebase(a))},this.queryFuncs.length>1?this.stopWatch=this.sync._watch(this._buildWatchFn({}),a):a(this.queryString)},l.execQuery=function(a,b){this[a]=b,this._updateQuery(this.query)},l.stop=function(){q.immediate(this.stopWatch),this.query.off("value",void 0,this),c.prototype.stop.apply(this,arguments)},l._onSuccess=function(a){this.next.start(this.sync.constructor.createNode(a))},l._onError=function(){this.next.start(void 0)},l._updateQuery=function(a){var b,c,d,e,f;for(this.query.off("value",void 0,this),b=0,d=(c=p).length;d>b;++b)e=c[b],(f=this[e])&&(a=a[e].apply(a,f));a.on("value",i),this.query.off("value",i),a.on("value",this._onSuccess,this._onError,this),this.query=a},d}(r),t=function(c){function d(){d.superclass.apply(this,arguments),this.stopWatchFns=[],this.queries=[],this.mappedResult=[]}var f=a((b(d,c).displayName="MapFlow",d),c).prototype;return f.start=function(a){function b(a,b){var e,g=this;return e=function(b){var c,d,e,g,h;for(f[a]=(this.flatten?x:w).createNode(b,a),c=!0,d=0,g=(e=f).length;g>d;++d)h=e[d],h||(c=!1);c&&this.next.start(f)},c._watch(this._buildWatchFn(b),function(b){var c,f;b&&((c=d[a])&&c.off("value",void 0,g),f=r.createFirebase(b),f.on("value",i),c&&c.off("value",i),d[a]=f,f.on("value",e,i,g))})}var c,d,f,g,h,j;if(this.stop(),!e(a))throw new TypeError("Map require result is array");if(c=this.sync,d=this.queries,f=this.mappedResult,f.length=a.length,0===a.length)return this.next.start(f);for(g=[],h=0,j=a.length;j>h;++h)g.push(b.call(this,h,a[h]));this.stopWatchFns=g},f.stop=function(){var a,b,d,e,f;for(a=this.stopWatchFns,b=this.queries,q.immediate(function(){var b,c,d;for(b=(c=a).length-1;b>=0;--b)d=c[b],d()}),d=0,e=b.length;e>d;++d)f=b[d],f&&f.off("value",void 0,this);this.mappedResult=[],this.queries=[],c.prototype.stop.apply(this,arguments)},d}(r),u=function(c){function d(){d.superclass.apply(this,arguments)}var f=a((b(d,c).displayName="FlattenDataFlow",d),c).prototype;return f.setSync=function(a,b){if(!(b instanceof t))throw new TypeError("Flatten require prev is map");b.flatten=!0,c.prototype.setSync.apply(this,arguments)},f.start=function(a){var b,c,d,f,g,h,i;if(!e(a))throw new TypeError("Flatten require result is array");for(b=[],c=0,d=a.length;d>c;++c)for(f=a[c],g=0,h=f.length;h>g;++g)i=f[g],i.$extend(void 0,b.push(i));this.next.start(b)},d}(q),v=function(c){function d(){d.superclass.apply(this,arguments),this.resolve=i}var e=a((b(d,c).displayName="ToSyncFlow",d),c).prototype;return e.start=function(a){var b=this;q.immediate(function(){b.sync._extend(a),b.resolve(b.sync.$node),b.resolve=i})},d}(q),w=function(){function a(){this.$head=this.$tail=this.$scope=this.$node=void 0}a.displayName="FireSync";var b,d=a.prototype;return a.createNode=function(a,b){return c(new y).$extend(a,b)},b={resolve:i,reject:i},d._addFlow=function(a){var b;return this._head||(this._head=function(){return a}),(b=this.$tail)&&(b.next=a),this.$tail=a,this},d.get=function(a){return this._addFlow(new s({queryString:a}))},d.clone=function(){var a,b,c,d,e;if(null!=(a=this.$deferred)&&a.promise)return this;if(b=new this.constructor,c="function"==typeof this._head?this._head():void 0){for(d=c.cloneChained(),b._head=function(){return d},e=d;c=e.next;)e=c;b.$tail=e}return b},d.sync=function(){var a,b,c=this;return(a=this.$node)?a:(this._addFlow(new v(null!=(b=this.$deferred)?{resolve:b.resolve}:void 0)),this._head().setSync(this),this.destroy=function(){var a;null!=(a=c.$deferred)&&a.reject(),c._head().stop(),c._head().setSync(void 0),q.immediate((a=c.$offDestroy,delete c.$offDestroy,a)),delete c.$scope},this._head().start(),this.$node=this.constructor.createNode())},d.syncWithScope=function(a){return this.$scope=a,this.sync(),this.$offDestroy=this.$scope.$on("$destroy",this.destroy),this.$node},d.defer=function(){return this.$deferred||(this.$deferred=a.q.defer()),this},d.promise=function(){return this.$deferred.promise},d._extend=function(a){this.$node.$extend(a)},d._watch=function(){var a;return(a=this.$scope).$watch.apply(a,arguments)},a}(),x=function(c){function d(){d.superclass.apply(this,arguments)}var f=a((b(d,c).displayName="FireCollection",d),c).prototype;return d.createNode=function(a){var b;return b=[],n(b,y.prototype),y.call(b),b.$extend(a)},f.map=function(a){return this._addFlow(new t({queryString:a}))},f.flatten=function(){return this._addFlow(new u)},k(p,function(a){this[a]=function(b){this._head().execQuery(a,b)}},d.prototype),f.syncWithScope=function(a,b){var d,f,g,h,i,j;for(d=this._head(),f=0,h=(g=p).length;h>f;++f)i=g[f],j=a.$eval(b[i]),e(j)&&(d[i]=j);return c.prototype.syncWithScope.apply(this,arguments)},d}(w),y=function(){function a(){var c,d=this;c=b,this.$ref=function(){return c},this.$_setFireProperties=function(b,e){return b&&(c=("function"==typeof b.ref?b.ref():void 0)||("function"==typeof b.$ref?b.$ref():void 0)||c),a.prototype.$_setFireProperties.call(d,b,e)}}a.displayName="FireNode";var b,c=a.prototype;return b={set:i,update:i,push:i,transaction:i,remove:i,setPriority:i,setWithPriority:i},c.$ref=i,c.$_setFireProperties=function(a,b){var c;return h(b)&&(this.$index=b),a&&(c=f(a.val),this.$name=c?a.name():a.$name,this.$priority=c?a.getPriority():a.$priority),c},c.$extend=function(b,c){function d(){var b=[];for(i in this)a.prototype[i]||b.push(i);return b}var f,h,i,j,k,l,m,o=this,p={}.hasOwnProperty;for(f=0,j=(h=d.call(this)).length;j>f;++f)i=h[f],delete this[i];if(this.$_setFireProperties(b,c))k=b.val(),e(this)?(l=-1,b.forEach(function(a){o[l+=1]=w.createNode(a,l)})):n(this,g(k)?k:{$value:k});else for(i in b)p.call(b,i)&&(m=b[i],this[i]=m);return this},k(b,function(a,b){this["$"+b]=function(){var a;(a=this.$ref())[b].apply(a,arguments)}},a.prototype),c.$increase=function(a){a||(a=1),this.$ref().transaction(function(b){return b+a})},c.$decrease=function(a){a||(a=1),this.$ref().transaction(function(b){return b-a})},a}(),z=function(){function a(){var a,d;return a=c(this),d=new b.FirebaseSimpleLogin(b.root,function(c,d){b.immediate(function(){return c?m({},a):(m(d||{},a),void 0)})}),k(["login","logout"],function(a){this[a]=function(){d[a].apply(d,arguments)}},this),a}a.displayName="FireAuth";var b=(a.prototype,a);return a}(),A=["$interpolate","$immediate","Firebase","FirebaseUrl"].concat(function(a,b,c,d){return q.interpolate=a,q.immediate=b,r.Firebase=c,r.FirebaseUrl=d,!0}),B=["$q","AngularOnFireDataFlow"].concat(function(a){return w.q=a,w}),C=["FireSync"].concat(function(){return x}),D=["$parse"].concat(function(a){return{restrict:"A",link:function(b,c,d){k(d.fbSync.split(/,\ ?/),function(c){var e,f;e=void 0,f=a(c),b.$watch(f,function(a){var c;null!=(null!=a?a.clone:void 0)&&(e&&e.destroy(),e=a.clone(),e instanceof x&&k(p,function(a){var c,f;c=d["fb"+a[0].toUpperCase()+a.substr(1)],c&&((f=b.$eval(c))&&e[a](f),b.$watchCollection(c,function(b){e[a](b)}))}),c=e.syncWithScope(b,d),e!==a&&f.assign(b,c))})})}}}),E=["$q","$immediate","Firebase","FirebaseUrl","FirebaseSimpleLogin"].concat(function(a,b,c,d,e){var f;return f=new c(d),z.immediate=b,z.root=f,z.FirebaseSimpleLogin=e,z}),F=this.FirebaseSimpleLogin||i,o("angular-on-fire",[]).value({Firebase:Firebase,FirebaseUrl:"https://YOUR_FIREBASE_NAME.firebaseIO.com/"}).factory({AngularOnFireDataFlow:A,FireSync:B,FireCollection:C,FireAuth:E}).directive({fbSync:D}).config(["$provide","$injector"].concat(function(a,b){b.has("$immediate")||a.factory("$immediate",["$timeout"].concat(j)),b.has("FirebaseSimpleLogin")||a.value("FirebaseSimpleLogin",F)}))}).call(this);