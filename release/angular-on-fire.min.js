/*! angular-on-fire - v0.1.0 - 2013-10-10
* Copyright (c) 2013 [tomchentw](https://github.com/tomchentw/);
 Licensed MIT */
(function(){function a(a,b){function c(){}return c.prototype=(a.superclass=b).prototype,(a.prototype=new c).constructor=a,"function"==typeof b.extended&&b.extended(a),a}function b(a,b){var c={}.hasOwnProperty;for(var d in b)c.call(b,d)&&(a[d]=b[d]);return a}function c(a){function b(){}return b.prototype=a,new b}var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F;d=angular.isString,e=angular.isArray,f=angular.isFunction,g=angular.isObject,h=angular.isNumber,i=angular.noop,j=angular.identity,k=angular.forEach,l=angular.bind,m=angular.copy,n=angular.extend,o=angular.module,p=["limit","startAt","endAt"],q=function(){function a(a){n(this,a),this.next=void 0}a.displayName="DataFlow";var b=a.prototype;return b._clone=function(){var a,b;return a=new this.constructor(this),(b=this.next)&&(a.next=b._clone()),a},b._setSync=function(a){var b;this.sync=a,(b=this.next)&&b._setSync(a,this)},b.stop=function(){this.next&&this.next.stop()},a}(),r=function(c){function e(){var a;e.superclass.apply(this,arguments),this.queryFuncs=[],a=q.interpolate,this.queryStr.match(f)&&k(this.queryStr.split(f),function(b,c){this.queryFuncs.push(c%2?a("{{ "+b+" }}"):b)},this)}var f,g=a((b(e,c).displayName="InterpolateFlow",e),c).prototype;return e.createFirebase=function(a){return a||(a=""),"http"!==a.substr(0,4)&&(a=this.FirebaseUrl+a),new this.Firebase(a)},f=/\{\{\s*(\S*)\s*\}\}/g,g._buildWatchFn=function(a){var b;return b=this.queryFuncs,function(c){var e;return e="",k(b,function(b,f){var g;if(f%2){if(g=b(c)||b(a),!d(g)||!g.length)return e=void 0}else g=b;d(e)&&(e+=g)}),e}},e}(q),s=function(c){function d(){d.superclass.apply(this,arguments)}var e=a((b(d,c).displayName="GetFlow",d),c).prototype;return e._callNext=function(a){this.next.start(this.sync.constructor.createNode(a))},e._setQuery=function(a){var b,c,d,e,f;for(b=this.query,b&&b.off("value",void 0,this),c=0,e=(d=p).length;e>c;++c)f=d[c],f in this&&(a=a[f].apply(a,this[f]));this.query=a,b||this.query.on("value",i),this.query.on("value",this._callNext,i,this)},e.execQuery=function(a,b){this[a]=b,this.query&&this._setQuery(this.query)},e.start=function(){var a,b=this;a=function(a){a&&b._setQuery(r.createFirebase(a))},this.queryFuncs.length?this.stopWatch=this.sync._watch(this._buildWatchFn({}),a):a(this.queryStr)},e.stop=function(){var a;(a=this.stopWatch)&&q.immediate(a),(a=this.query)&&a.off("value",void 0,this),c.prototype.stop.call(this)},d}(r),t=function(c){function d(){d.superclass.apply(this,arguments),this.stopWatches=[],this.queries=[],this.mappedResult=[]}var f=a((b(d,c).displayName="MapFlow",d),c).prototype;return f.start=function(a){var b,c,d,f,g,h=this;if(this.stop(),!e(a))throw new TypeError("Map require result is array");return b=this.sync,c=this.stopWatches,d=this.queries,f=this.mappedResult,g=this.queryFuncs,f.length=a.length,0===a.length?this.next.start(f):(k(a,function(a,e){c.push(b._watch(h._buildWatchFn(a),function(a){var b,c;a&&((b=d[e])&&b.off("value",void 0,h),c=r.createFirebase(a),d[e]||c.on("value",i),c.on("value",function(a){var b,c,d,g,h;for(f[e]=(this.flatten?x:w).createNode(a,e),b=!0,c=0,g=(d=f).length;g>c;++c)h=d[c],h||(b=!1);b&&this.next.start(f)},i,h),d[e]=c)}))}),void 0)},f.stop=function(){var a,b;for(a=this.stopWatches,this.stopWatches=[],q.immediate(function(){var b,c,d;for(b=(c=a).length-1;b>=0;--b)d=c[b],d()});b=this.queries.shift();)b.off();this.mappedResult=[],c.prototype.stop.call(this)},d}(r),u=function(c){function d(){d.superclass.apply(this,arguments)}var f=a((b(d,c).displayName="FlattenDataFlow",d),c).prototype;return f._setSync=function(a,b){if(!(b instanceof t))throw new TypeError("Flatten require prev is map");b.flatten=!0,c.prototype._setSync.apply(this,arguments)},f.start=function(a){var b;if(!e(a))throw new TypeError("Flatten require result is array");b=[],k(a,function(a){k(a,function(a){a.$extend(void 0,b.push(a))})}),this.next.start(b)},d}(q),v=function(c){function d(){d.superclass.apply(this,arguments)}var e=a((b(d,c).displayName="ToSyncFlow",d),c).prototype;return e.start=function(a){var b=this;q.immediate(function(){b.sync._extend(a),b.resolve&&(b.resolve(b.sync.$node),b.resolve=void 0)})},d}(q),w=function(){function a(){this.$head=this.$tail=this.$scope=this.$node=void 0}a.displayName="FireSync";var b=a.prototype;return a.createNode=function(a,b){var d;return d=new y,d=c(d),d.$extend(a,b)},b._addFlow=function(a){var b;return this._head||(this._head=function(){return a}),(b=this.$tail)&&(b.next=a),this.$tail=a,this},b.get=function(a){return this._addFlow(new s({queryStr:a}))},b.clone=function(){var a,b,c,d;if(this.$deferred)return this;if(a=new this.constructor,b="function"==typeof this._head?this._head():void 0){for(c=b._clone(),a._head=function(){return c},d=c;b=d.next;)d=b;a.$tail=d}return a},b.sync=function(){var a,b,c=this;return(a=this.$node)?a:(this._addFlow(new v(null!=(b=this.$deferred)?{resolve:b.resolve}:void 0)),this._head()._setSync(this),this.destroy=function(){var a;null!=(a=c.$deferred)&&a.reject(),c._head().stop(),c._head()._setSync(void 0),q.immediate((a=c.$offDestroy,delete c.$offDestroy,a)),delete c.$scope},this._head().start(),this.$node=this.constructor.createNode())},b.syncWithScope=function(a){return this.$scope=a,this.sync(),this.$offDestroy=this.$scope.$on("$destroy",this.destroy),this.$node},b.defer=function(){return this.$defer||(this.$deferred=a.q.defer()),this},b.promise=function(){return this.$deferred.promise},b._extend=function(a){this.$node.$extend(a)},b._watch=function(){var a;return(a=this.$scope).$watch.apply(a,arguments)},a}(),x=function(c){function d(){d.superclass.apply(this,arguments)}var f=a((b(d,c).displayName="FireCollection",d),c).prototype;return d.createNode=function(a){var b;return b=[],n(b,y.prototype),y.call(b),b.$extend(a)},f.map=function(a){return this._addFlow(new t({queryStr:a}))},f.flatten=function(){return this._addFlow(new u)},k(p,function(a){this[a]=function(b){this._head().execQuery(a,b)}},d.prototype),f.syncWithScope=function(a,b){var d,f,g,h,i,j;for(d=this._head(),f=0,h=(g=p).length;h>f;++f)i=g[f],j=a.$eval(b[i]),e(j)&&(d[i]=j);return c.prototype.syncWithScope.apply(this,arguments)},d}(w),y=function(){function a(){var b,d=this;b=c.noopRef,this.$ref=function(){return b},this.$_setFireProperties=function(c,e){return c&&(b=("function"==typeof c.ref?c.ref():void 0)||("function"==typeof c.$ref?c.$ref():void 0)||b),a.prototype.$_setFireProperties.call(d,c,e)}}a.displayName="FireNode";var b=a.prototype,c=a;return a.noopRef={set:i,update:i,push:i,transaction:i,remove:i,setPriority:i,setWithPriority:i},b.$ref=i,b.$_setFireProperties=function(a,b){var c;return h(b)&&(this.$index=b),a&&(c=f(a.val),this.$name=c?a.name():a.$name,this.$priority=c?a.getPriority():a.$priority),c},b.$extend=function(b,c){var d,f,h,i,j={}.hasOwnProperty,k=this;if(b)for(d in this)j.call(this,d)&&(a.prototype[d]||delete this[d]);if(this.$_setFireProperties(b,c))f=b.val(),e(this)?(h=-1,b.forEach(function(a){k[h+=1]=w.createNode(a,h)})):n(this,g(f)?f:{$value:f});else for(d in b)j.call(b,d)&&(i=b[d],this[d]=i);return this},k(a.noopRef,function(a,b){this["$"+b]=function(){var a;(a=this.$ref())[b].apply(a,arguments)}},a.prototype),b.$increase=function(a){return a||(a=1),this.$ref().transaction(function(b){return b+a})},b.$decrease=function(a){return a||(a=1),this.$ref().transaction(function(b){return b-a})},a}(),z=function(){function a(){var a,d;return a=c(this),d=new b.FirebaseSimpleLogin(b.root,function(c,d){b.immediate(function(){return c?m({},a):(m(d||{},a),void 0)})}),k(["login","logout"],function(a){this[a]=function(){return d[a].apply(d,arguments)}},this),a}a.displayName="FireAuth";var b=(a.prototype,a);return a}(),A=["$interpolate","$immediate","Firebase","FirebaseUrl"].concat(function(a,b,c,d){return q.interpolate=a,q.immediate=b,r.Firebase=c,r.FirebaseUrl=d,!0}),B=["$q","AngularOnFireDataFlow"].concat(function(a){return w.q=a,w}),C=["FireSync"].concat(function(){return x}),D=["$parse"].concat(function(a){return{restrict:"A",link:function(b,c,d){k(d.fbSync.split(/,\ ?/),function(c){var e,f;e=void 0,f=a(c),b.$watch(f,function(a){var c;null!=(null!=a?a.clone:void 0)&&(e&&e.destroy(),e=a.clone(),e instanceof x&&k(p,function(a){var c,f;c=d["fb"+a[0].toUpperCase()+a.substr(1)],c&&((f=b.$eval(c))&&e[a](f),b.$watchCollection(c,function(b){e[a](b)}))}),c=e.syncWithScope(b,d),e!==a&&f.assign(b,c))})})}}}),E=["$q","$immediate","Firebase","FirebaseUrl","FirebaseSimpleLogin"].concat(function(a,b,c,d,e){var f;return f=new c(d),z.immediate=b,z.root=f,z.FirebaseSimpleLogin=e,z}),F=this.FirebaseSimpleLogin||i,o("angular-on-fire",[]).value({Firebase:Firebase,FirebaseUrl:"https://YOUR_FIREBASE_NAME.firebaseIO.com/"}).factory({AngularOnFireDataFlow:A,FireSync:B,FireCollection:C,FireAuth:E}).directive({fbSync:D}).config(["$provide","$injector"].concat(function(a,b){b.has("$immediate")||a.factory("$immediate",["$timeout"].concat(j)),b.has("FirebaseSimpleLogin")||a.value("FirebaseSimpleLogin",F)}))}).call(this);