/*! angular-on-fire - v0.1.0 - 2013-10-02
* Copyright (c) 2013 [tomchentw](https://github.com/tomchentw/);
 Licensed MIT */
(function(){function a(a,b,c){return function(){return(c||a)[b].apply(a,arguments)}}function b(a){function b(){}return b.prototype=a,new b}function c(a,b){var c={}.hasOwnProperty;for(var d in b)c.call(b,d)&&(a[d]=b[d]);return a}function d(a,b){function c(){}return c.prototype=(a.superclass=b).prototype,(a.prototype=new c).constructor=a,"function"==typeof b.extended&&b.extended(a),a}var e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x;e=angular.isString,f=angular.isArray,g=angular.isFunction,h=angular.isObject,i=angular.isNumber,j=angular.noop,k=angular.forEach,l=angular.bind,m=angular.extend,n=angular.module,o=function(){function c(){return this._setFireProperties=a(this,"_setFireProperties",e),this.$ref=d,b(this)}c.displayName="FireNode";var d,e=c.prototype;return d={set:j,update:j,push:j,transaction:j},e._setFireProperties=function(a){var b;return b=g(a.val),this.$ref=b?a.ref():a.$ref,this.$name=b?a.name():a.$name,this.$priority=b?a.getPriority():a.$priority,b},e.extend=function(a){var b,d,e,g,i={}.hasOwnProperty,j=this;if(!a)return this;for(b in this)i.call(this,b)&&(c.prototype[b]||delete this[b]);if(this._setFireProperties(a))d=a.val(),f(this)?(e=-1,a.forEach(function(a){j[e+=1]=p(a)})):m(this,h(d)?d:{$value:d});else for(b in a)i.call(a,b)&&(g=a[b],this[b]=g);return this},k(d,function(a,b){this["$"+b]=function(){var a;(a=this.$ref)[b].apply(a,arguments)}},c.prototype),e.$increase=function(a){return a||(a=1),this.$ref.transaction(function(b){return b+a})},c}(),p=function(a,b){var d;return d=null!=b&&b.toCollection||f(null!=a?a.val():void 0)?c([],o.prototype):new o,d.extend(a)},q=function(){function a(a){m(this,a)}a.displayName="DataFlow";var b=a.prototype;return a.immediate=j,b._setSync=function(a){var b;this.sync=a,(b=this.next)&&b._setSync(a,this)},b.stop=function(){this.next&&this.next.stop()},a}(),r=function(a){function b(){b.superclass.apply(this,arguments)}var e=d((c(b,a).displayName="ToSyncFlow",b),a).prototype;return e.start=function(a){var b=this;q.immediate(function(){b.sync.node.extend(a)})},b}(q),s=function(){function b(){this.destroy=a(this,"destroy",c),this._head=this._tail=this._scope=this.node=void 0}b.displayName="FireSync";var c=b.prototype;return c._addFlow=function(a){var b;return this._head||(this._head=a),(b=this._tail)&&(b.next=a),this._tail=a,this},c.get=function(a,b){var c;return this._addFlow(new u((c=b||{},c.queryStr=a,c)))},c.map=function(){return this._addFlow(new v({queryString:queryString}))},c.flatten=function(){return this._addFlow(new w)},c.sync=function(){return this.node=p(void 0,this._tail),this._addFlow(new r),this._head._setSync(this),this._head.start(),this.node},c.syncWithScope=function(a){return this._scope=a,this.sync()},c.destroy=function(){this._head.stop(),delete this._scope},c._watch=function(){var a;return(a=this._scope).$watch.apply(a,arguments)},b}(),t=function(a){function b(){var a;b.superclass.apply(this,arguments),this.queryFuncs=[],a=q.interpolate,f.test(this.queryStr)&&k(this.queryStr.split(f),function(b,c){this.queryFuncs.push(c%2?a("{{ "+b+" }}"):b)},this)}var f,g=d((c(b,a).displayName="InterpolateFlow",b),a).prototype;return f=/\{\{\s*(\S*)\s*\}\}/g,g._buildWatchFn=function(a){var b;return b=this.queryFuncs,function(c){var d;return d="",k(b,function(b,f){var g,h;return g=0===f%2?b:(h=b(c)||b(a))?h:d=void 0,e(d)?d+=g:void 0}),d}},b}(q),u=function(a){function b(){b.superclass.apply(this,arguments)}var e=d((c(b,a).displayName="GetFlow",b),a).prototype;return e.start=function(){var a,b,c=this;a=function(a){c.next.start(p(a,c))},b=function(b){b&&(c.query&&c.query.off("value"),c.query=new Firebase(b),c.query.on("value",a))},this.queryFuncs.length?this.stopWatch=this.sync._watch(this._buildWatchFn({}),b):b(this.queryStr)},e.stop=function(){var b;(b=this.stopWatch)&&b(),this.query.off("value"),a.prototype.stop.call(this)},b}(t),v=function(a){function b(){b.superclass.apply(this,arguments),this.stopWatches=[],this.queries=[],this.mappedResult=[]}var e=d((c(b,a).displayName="MapFlow",b),a).prototype;return e._setSync=function(b,c){c.toCollection=!0,a.prototype._setSync.apply(this,arguments)},e.start=function(a){var b,c,d,e,g,h=this;if(this.stop(),!f(a))throw new TypeError("Map require result is array");b=this.sync,c=this.stopWatches,d=this.queries,e=this.mappedResult,g=this.queryFuncs,k(a,function(a,f){c.push(b._watch(h._buildWatchFn(a),function(a){var b,c;a&&((b=d[f])&&b.off(),c=new Firebase(a),c.on("value",function(a){var b,c,d,g,h;for(e[f]=p(a,this),b=!0,c=0,g=(d=e).length;g>c;++c)h=d[c],h||(b=!1);b&&this.next.start(e)},j,h),d[f]=c)}))})},e.stop=function(){for(var b;b=this.stopWatches.shift();)b();for(;b=this.queries.shift();)b.off();this.mappedResult=[],a.prototype.stop.call(this)},b}(t),w=function(a){function b(){b.superclass.apply(this,arguments)}var e=d((c(b,a).displayName="FlattenDataFlow",b),a).prototype;return e._setSync=function(b,c){c.toCollection=!0,a.prototype._setSync.apply(this,arguments)},e.start=function(a){var b;if(!f(a))throw new TypeError("Flatten require result is array");b=[],k(a,function(a){b.push.apply(b,a)}),this.next.start(b)},b}(q),x=["$timeout","$interpolate"].concat(function(a,b){return q.immediate=a,q.interpolate=b,s}),n("angular-on-fire",[]).factory({FireSync:x})}).call(this);